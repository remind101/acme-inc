version: 2.1

workflows:
  build-and-test:
    jobs:
      - docker_image:
          context:
            - docker-hub
            - aws-ecr
      - test

jobs:
  # docker-build is a small script for building, tagging and pushing docker images within CircleCI.
  docker_image:
    docker:
      # build docker images and push them into a remote docker hub.
      - image: remind101/docker-build:isobit-compose-ecr
    environment:
      DOCKER_BUILDKIT: 1
    steps:
      - checkout
      - setup_remote_docker:
          version: 20.10.14
      - run: docker-build # build, tag and push
      - run: docker-build aws-ecr-put-default-lifecycle-policy

  test:
    working_directory: /go/src/github.com/remind101/acme-inc
    docker:
      # Primary container image where all the steps run.
      - image: circleci/golang:1.10
    steps:
      - checkout
      - run: go test
